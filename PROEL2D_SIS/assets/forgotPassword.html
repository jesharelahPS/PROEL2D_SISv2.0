<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Forgot Password</title>
    <link rel="stylesheet" href="css/forgotPass.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>

<body>
    <div class="container">
        <!-- Logo -->
        <img src="../img/logo.png" alt="ACT Logo" class="logo">

        <!-- Title -->
        <h2 class="login-title">Reset Your Password</h2>
        <p class="tagline">Enter your email or phone to receive a verification code.</p>

        <!-- Step 1: Email + CAPTCHA + Send -->
        <div class="section" id="step1">
            <div class="floating">
                <input type="text" id="userInput" placeholder="Email or Phone Number">
            </div>

            <div class="captcha-box">
                <div class="captcha-image">[ CAPTCHA ]</div>
                <div class="floating">
                    <input type="text" id="captcha" placeholder="Enter CAPTCHA">
                </div>
            </div>

            <p id="statusSendCode" class="lockout-message"></p>
            <button id="btnSendCode">Send Verification Code</button>
        </div>

        <!-- Step 2: Verification Code -->
        <div class="section" id="step2" style="display:none;">
            <div class="verification-codes">
                <input type="text" maxlength="1" class="code-box">
                <input type="text" maxlength="1" class="code-box">
                <input type="text" maxlength="1" class="code-box">
                <input type="text" maxlength="1" class="code-box">
                <input type="text" maxlength="1" class="code-box">
            </div>
            <!-- Incorrect code / status message right below OTP -->
            <p id="statusVerify" class="lockout-message errorOTP"></p>


            <!-- Resend link above verify button -->
            <a href="#" id="resendLink" class="verification-message"
                style="display:inline-block;margin-bottom: -10px; text-align:center;">Resend
                verification code</a>
            <button id="btnVerify">Verify Code</button>
        </div>


        <!-- Step 3: Reset Password -->
        <div class="section" id="passwordReset" style="display:none;">
            <div class="floating password-container">
                <input type="password" id="newPassword" placeholder="New Password">
                <i class="toggle-password fas fa-eye-slash" id="toggleNewPassword"></i>
            </div>
            <div class="floating password-container">
                <input type="password" id="confirmPassword" placeholder="Confirm Password">
                <i class="toggle-password fas fa-eye-slash" id="toggleConfirmPassword"></i>
            </div>
            <p id="statusReset" class="lockout-message"></p>
            <button id="btnResetPassword">Reset Password</button>
        </div>

        <!-- Back to login -->
        <a class="forgot" id="backToLogin">Back to Login</a>
    </div>

    <script>
        // === ELEMENTS ===
        const step1 = document.getElementById("step1");
        const step2 = document.getElementById("step2");
        const passwordResetDiv = document.getElementById("passwordReset");

        const userInput = document.getElementById("userInput");
        const captchaInput = document.getElementById("captcha");

        const statusSendCode = document.getElementById("statusSendCode");
        const statusVerify = document.getElementById("statusVerify");
        const statusReset = document.getElementById("statusReset");

        const codeBoxes = document.querySelectorAll(".code-box");
        const timerSpan = document.getElementById("timer");
        const resendLink = document.getElementById("resendLink");

        const newPassword = document.getElementById("newPassword");
        const confirmPassword = document.getElementById("confirmPassword");

        const btnSendCode = document.getElementById("btnSendCode");
        const btnVerify = document.getElementById("btnVerify");
        const btnResetPassword = document.getElementById("btnResetPassword");
        const backToLogin = document.getElementById("backToLogin");

        // === STATIC FUNCTIONS ===
        const ForgotPassword = {

            // === VALIDATIONS ===
            validateCaptcha: () => captchaInput.value.trim() === "12345", // static captcha

            validateEmailOrPhone: () => {
                const val = userInput.value.trim();
                const phoneRegex = /^\d{10,15}$/;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(val) || phoneRegex.test(val);
            },

            validateOTP: () => Array.from(codeBoxes).every(box => box.value.trim() !== "") &&
                Array.from(codeBoxes).map(box => box.value.trim()).join("") === "54321",

            validatePassword: () => {
                const pwd = newPassword.value.trim();
                const confirm = confirmPassword.value.trim();
                return pwd.length >= 6 && pwd === confirm;
            },

            // === FORM MANAGEMENT ===
            clearStep1: () => {
                userInput.value = "";
                captchaInput.value = "";
                statusSendCode.textContent = "";
            },

            clearStep2: () => {
                codeBoxes.forEach(box => box.value = "");
                statusVerify.textContent = "";
            },

            clearStep3: () => {
                newPassword.value = "";
                confirmPassword.value = "";
                statusReset.textContent = "";
            },

            showStep: (step) => {
                step1.style.display = "none";
                step2.style.display = "none";
                passwordResetDiv.style.display = "none";

                step.style.display = "flex";
            },

            // === ACTIONS ===
            sendCode: () => {
                statusSendCode.textContent = "";
                if (!userInput.value.trim()) {
                    statusSendCode.textContent = "Enter email or phone.";
                    return false;
                }
                if (!ForgotPassword.validateEmailOrPhone()) {
                    statusSendCode.textContent = "Invalid email or phone format!";
                    return false;
                }
                if (!ForgotPassword.validateCaptcha()) {
                    statusSendCode.textContent = "Invalid CAPTCHA!";
                    return false;
                }

                statusSendCode.textContent = "Verification code sent!";
                ForgotPassword.clearStep2();
                ForgotPassword.showStep(step2);
                ForgotPassword.startResendTimer();
                return true;
            },

            verifyCode: () => {
                statusVerify.textContent = "";
                if (!Array.from(codeBoxes).every(box => box.value.trim() !== "")) {
                    statusVerify.textContent = "Enter full verification code.";
                    return false;
                }
                if (!ForgotPassword.validateOTP()) {
                    statusVerify.textContent = "Incorrect code!";
                    return false;
                }

                statusVerify.textContent = "Code verified!";
                ForgotPassword.clearStep3();
                ForgotPassword.showStep(passwordResetDiv);
                return true;
            },

            resetPassword: () => {
                statusReset.textContent = "";
                if (!newPassword.value.trim() || !confirmPassword.value.trim()) {
                    statusReset.textContent = "Fill both password fields.";
                    return false;
                }
                if (!ForgotPassword.validatePassword()) {
                    statusReset.textContent = "Passwords must match and be at least 6 characters!";
                    return false;
                }

                statusReset.textContent = "Password reset successful! Redirecting to login...";
                setTimeout(() => window.location.href = "login.html", 1000);
                return true;
            },


            // === TIMER ===
            startResendTimer: () => {
                let timeLeft = 60;
                timerSpan.textContent = timeLeft;
                resendLink.style.display = "none";
                document.getElementById("resendTimer").style.textAlign = "center";

                const interval = setInterval(() => {
                    timeLeft--;
                    timerSpan.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        resendLink.style.display = "inline-block";
                        document.getElementById("resendTimer").textContent = "";
                    }
                }, 1000);
            },

            resendCode: () => {
                statusSendCode.textContent = "Verification code resent!";
                ForgotPassword.startResendTimer();
            }
        };


        // === EVENT LISTENERS ===
        btnSendCode.addEventListener("click", ForgotPassword.sendCode);
        btnVerify.addEventListener("click", ForgotPassword.verifyCode);
        btnResetPassword.addEventListener("click", ForgotPassword.resetPassword);
        resendLink.addEventListener("click", e => {
            e.preventDefault();
            ForgotPassword.resendCode();
        });
        backToLogin.addEventListener("click", () => window.location.href = "login.html");

        // === OTP AUTO-TAB ===
        codeBoxes.forEach((box, i) => {
            box.addEventListener("input", () => {
                if (box.value.length === 1 && i < codeBoxes.length - 1) codeBoxes[i + 1].focus();
                if (box.value.length === 0 && i > 0) codeBoxes[i - 1].focus();
            });
        });


        // === EYEBALL PASSWORD TOGGLE ===
        const togglePassword = (input, icon) => {
            icon.addEventListener("click", () => {
                if (input.type === "password") {
                    input.type = "text";
                    icon.classList.replace("fa-eye-slash", "fa-eye");
                } else {
                    input.type = "password";
                    icon.classList.replace("fa-eye", "fa-eye-slash");
                }
            });
        };

        togglePassword(newPassword, document.getElementById("toggleNewPassword"));
        togglePassword(confirmPassword, document.getElementById("toggleConfirmPassword"));


        // === AUTO-SELECT FIRST OTP BOX ===
        const focusFirstOTP = () => {
            if (codeBoxes.length) codeBoxes[0].focus();
        };

        // Modify showStep to include auto-focus for OTP
        ForgotPassword.showStep = (step) => {
            step1.style.display = "none";
            step2.style.display = "none";
            passwordResetDiv.style.display = "none";

            step.style.display = "flex";

            if (step === step2) focusFirstOTP(); // auto-focus first OTP box
        };


        // === RESEND LOGIC WITH COUNTDOWN ===
        const startResendCountdown = () => {
            let timeLeft = 60;
            resendLink.style.pointerEvents = "none";  // disable clicking
            resendLink.textContent = `Resend verification code (${timeLeft}s)`;

            const interval = setInterval(() => {
                timeLeft--;
                resendLink.textContent = `Resend verification code (${timeLeft}s)`;
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    resendLink.textContent = "Resend verification code";
                    resendLink.style.pointerEvents = "auto"; // enable clicking again
                }
            }, 1000);
        };

        // === ACTIONS ===
        ForgotPassword.resendCode = () => {
            statusSendCode.textContent = "Verification code resent!";
            startResendCountdown();
        };

        ForgotPassword.sendCode = () => {
            statusSendCode.textContent = "";
            if (!userInput.value.trim()) { statusSendCode.textContent = "Enter email or phone."; return false; }
            if (!ForgotPassword.validateEmailOrPhone()) { statusSendCode.textContent = "Invalid email or phone format!"; return false; }
            if (!ForgotPassword.validateCaptcha()) { statusSendCode.textContent = "Invalid CAPTCHA!"; return false; }

            statusSendCode.textContent = "Verification code sent!";
            ForgotPassword.clearStep2();
            ForgotPassword.showStep(step2);

            startResendCountdown();
            return true;
        };


    </script>
</body>

</html>